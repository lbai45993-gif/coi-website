---
// src/pages/events.astro
import Layout from "../layouts/Layout.astro";
import { getCollection } from "astro:content";
import { fmtDateTimeISO, isUpcoming } from "../lib/date";
import type { CollectionEntry } from "astro:content";

type EventEntry = CollectionEntry<"events">;

const BASE = import.meta.env.BASE_URL;
const toSrc = (path: string) => path.startsWith("http") ? path : `${BASE}${path.replace(/^\//, "")}`;
const FALLBACK_COVER = "images/events/default-cover.jpg";


// 仅取已发布
const allEvents: EventEntry[] = await getCollection(
  "events",
  (entry: EventEntry) => entry.data.published !== false
);

// 时间升序（早 → 晚）
allEvents.sort((a: EventEntry, b: EventEntry) => {
  const ad = new Date(a.data.start).getTime();
  const bd = new Date(b.data.start).getTime();
  return ad - bd;
});

// 分组
const upcoming: EventEntry[] = allEvents.filter((e: EventEntry) =>
  isUpcoming(e.data.end, e.data.start)
);

const past: EventEntry[] = allEvents
  .filter((e: EventEntry) => !isUpcoming(e.data.end, e.data.start))
  .sort((a: EventEntry, b: EventEntry) => new Date(b.data.start).getTime() - new Date(a.data.start).getTime());
---

<html lang="en">
  <head>
    <title>Events | Collage of Inclusion</title>
    <meta name="description" content="Browse community events and activities." />
  </head>
  <body>
    <Layout>
      <section class="mx-auto max-w-5xl px-4 py-10">
        <h1 class="text-3xl font-bold mb-6">Events</h1>

        {upcoming.length > 0 && (
          <div class="mb-10">
            <h2 class="text-xl font-semibold mb-4">Upcoming</h2>
            <ul class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
              {upcoming.map((e: EventEntry) => {
                const { slug, data } = e;
                const cover = data.cover
                  ? toSrc(data.cover)
                  : toSrc(FALLBACK_COVER);
                return (
                  <li class="rounded-2xl shadow-sm overflow-hidden bg-white">
                    <a href={`${BASE}events/${slug}`} class="block focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                      <img src={cover} alt={data.title} class="h-40 w-full object-cover" loading="lazy" />
                      <div class="p-4">
                        <h3 class="text-lg font-semibold line-clamp-2">{data.title}</h3>
                        <p class="mt-1 text-sm text-slate-600">
                          {fmtDateTimeISO(data.start)}{data.end ? ` - ${fmtDateTimeISO(data.end)}` : ""}
                        </p>
                        {data.location?.name && <p class="mt-1 text-sm text-slate-600">{data.location.name}</p>}
                        {data.summary && <p class="mt-2 text-sm text-slate-700 line-clamp-3">{data.summary}</p>}
                        {data.tags?.length ? (
                          <div class="mt-3 flex flex-wrap gap-2">
                            {data.tags.map((t: string) => <span class="px-2 py-0.5 text-xs rounded-full bg-slate-100">{t}</span>)}
                          </div>
                        ) : null}
                      </div>
                    </a>
                  </li>
                );
              })}
            </ul>
          </div>
        )}

        <div>
          <h2 class="text-xl font-semibold mb-4">Past</h2>
          {past.length === 0 ? (
            <p class="text-sm text-slate-600">No past events yet.</p>
          ) : (
            <ul class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
              {past.map((e: EventEntry) => {
                const { slug, data } = e;
                const cover = data.cover ? toSrc(data.cover) : toSrc(FALLBACK_COVER);
                return (
                  <li class="rounded-2xl shadow-sm overflow-hidden bg-white">
                    <a href={`${BASE}events/${slug}`} class="block focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                      <img src={cover} alt={data.title} class="h-40 w-full object-cover" loading="lazy" />
                      <div class="p-4">
                        <h3 class="text-lg font-semibold line-clamp-2">{data.title}</h3>
                        <p class="mt-1 text-sm text-slate-600">
                          {fmtDateTimeISO(data.start)}{data.end ? ` - ${fmtDateTimeISO(data.end)}` : ""}
                        </p>
                        {data.location?.name && <p class="mt-1 text-sm text-slate-600">{data.location.name}</p>}
                        {data.summary && <p class="mt-2 text-sm text-slate-700 line-clamp-3">{data.summary}</p>}
                        {data.tags?.length ? (
                          <div class="mt-3 flex flex-wrap gap-2">
                            {data.tags.map((t: string) => <span class="px-2 py-0.5 text-xs rounded-full bg-slate-100">{t}</span>)}
                          </div>
                        ) : null}
                      </div>
                    </a>
                  </li>
                );
              })}
            </ul>
          )}
        </div>
      </section>
    </Layout>
  </body>
</html>
