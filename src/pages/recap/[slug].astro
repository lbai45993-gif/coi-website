---
// src/pages/recap/[slug].astro
import Layout from "../../layouts/Layout.astro";
import { getCollection, type CollectionEntry } from "astro:content";
import { fmtDate } from "../../lib/date";

type RecapEntry = CollectionEntry<"recap">;

const FALLBACK_COVER = "/images/recap/1.jpg";

export async function getStaticPaths() {
  const entries: RecapEntry[] = await getCollection(
    "recap",
    (entry: RecapEntry) => entry.data.published !== false
  );
  return entries.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const BASE = import.meta.env.BASE_URL;

const { entry } = Astro.props as { entry: RecapEntry };
const { data } = entry;
const { Content } = await entry.render();

const cover = data.gallery?.[0] ?? FALLBACK_COVER;
const pageTitle = `${data.title} | Collage of Inclusion`;
const pageDesc = data.summary ?? `${data.title} (${fmtDate(data.date)})`;
---

<html lang="en">
  <head>
    <title>{pageTitle}</title>
    <meta name="description" content={pageDesc} />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={pageDesc} />
    <meta property="og:type" content="article" />
    <meta property="og:image" content={cover} />
  </head>
  <body>
    <Layout>
      <article class="mx-auto max-w-3xl px-4 py-10">
        <!-- <a href="/recap" class="text-sm text-indigo-600 hover:underline">&larr; Back to Recap</a> -->
         <a href={`${BASE}recap`} class="text-sm text-indigo-600 hover:underline">&larr; Back to Recap</a>

        <header class="mt-3">
          <h1 class="text-3xl font-bold">{data.title}</h1>
          {data.date && <p class="mt-2 text-slate-600">{fmtDate(data.date)}</p>}
        </header>

        <img
          src={cover}
          alt={data.title}
          class="mt-6 w-full rounded-2xl shadow-sm object-cover"
          loading="eager"
        />

        {/* 画廊（若有多图） */}
        {data.gallery && data.gallery.length > 1 && (
          <div class="mt-6 grid grid-cols-2 md:grid-cols-3 gap-3">
            {data.gallery.slice(1).map((src: string) => (
              <img src={src} alt={data.title} class="w-full h-28 object-cover rounded-lg" loading="lazy" />
            ))}
          </div>
        )}

        <div class="prose prose-slate mt-8 max-w-none">
          <Content />
        </div>

        {data.facebook_post_url && (
          <p class="mt-8 text-sm">
            Facebook:{" "}
            <a href={data.facebook_post_url} class="text-indigo-600 hover:underline" target="_blank" rel="noopener">
              {data.facebook_post_url}
            </a>
          </p>
        )}
      </article>
    </Layout>
  </body>
</html>
